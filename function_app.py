import azure.functions as func
import logging
import pyodbc
from datetime import datetime


app = func.FunctionApp(http_auth_level=func.AuthLevel.ANONYMOUS)

@app.route(route="updateskillinventory")
def updateskillinventory(req: func.HttpRequest) -> func.HttpResponse:
    logging.info('Python HTTP trigger function processed a request.')

    driver = "{ODBC Driver 18 for SQL Server}"
    server = 'tcp:lps-ad-sql-server-2024jan.database.windows.net,1433'
    database = 'sql-database'
    username = 'CloudSA9d60b0b0'
    password = '@dmin2024'
    connection_string = f'Driver={driver};Server={server};Database={database};Uid={username};Pwd={password};Encrypt=Yes;TrustServerCertificate=no;Connection Timeout=300;'

    name_val = req.params.get('nameval')
    if not name_val:
        try:
            req_body = req.get_json()
        except ValueError:
            pass
        else:
            cat_val = req_body.get('catval')
            name_val = req_body.get('nameval')
            ivt_val = req_body.get('ivtval')
            date_val = datetime.strptime(req_body.get('dateval'), "%d/%m/%Y").strftime("%Y-%m-%dT%H:%M:%S")

    with pyodbc.connect(connection_string) as conn:
        with conn.cursor() as cursor:
            if cat_val == 'Skill':
                insert_query = "INSERT INTO [Skill] (Name, Skill, acq_date) VALUES (?, ?, ?)"
            if cat_val == 'Certificate':
                insert_query = "INSERT INTO [Certificate] (Name, Certificate, acq_date) VALUES (?, ?, ?)"
            values = (name_val, ivt_val, date_val)
            cursor.execute(insert_query, values)
            conn.commit()

    if name_val or ivt_val or date_val:
        return func.HttpResponse(f"The following record has been inserted into database: {name_val}, {ivt_val}, {date_val}.")
    else:
        return func.HttpResponse(
             "This HTTP triggered function executed successfully. Pass a name in the query string or in the request body for a personalized response.",
             status_code=200
        )

import os
from openai import AzureOpenAI

@app.route(route="LD_copilot")
def LD_reply(req: func.HttpRequest):
    
    req_body = req.get_json()
    Quesiton = req_body.get('question')
    
    client = AzureOpenAI(
      azure_endpoint = "https://aisdu-gpt4.openai.azure.com/", 
      api_key=os.getenv("AZURE_OPENAI_KEY"),  
      api_version="2024-02-15-preview"
    )
    
    
    message_text = [{"role":"system","content":"""You are an AI assistant that helps people find information. Reference Data as in below
                     '{"0":{"CRM ID":"20200221-8607","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Commerce and Economic Development Bureau","Account Name (Local)":"\\u5546\\u52d9\\u53ca\\u7d93\\u6fdf\\u767c\\u5c55\\u5c40","End Customer":"Commerce and Economic Development Bureau","Opportunity Name (English)":"Implementation of Phase 3 of the Trade Single Window System","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O4 - Customer Decision","Winning Chance":"Low","TCV (converted)":1585000000.4800000191,"EBITDA%":0.054,"Decision Date":"30\\/5\\/2023","Project Start Date":"17\\/6\\/2023","Project End Date":"17\\/6\\/2036","4 Initiatives (Alberto 0224)":"Smart City"},"1":{"CRM ID":"20220427-1345","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Health Bureau","Account Name (Local)":"\\u91ab\\u52d9\\u885e\\u751f\\u5c40","End Customer":"Health Bureau","Opportunity Name (English)":"IT Support for the New Chinese Medicine Hospital (infra)","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O2 - Qualify","Winning Chance":"Low","TCV (converted)":388500388.5003885031,"EBITDA%":0.08,"Decision Date":"30\\/6\\/2023","Project Start Date":"26\\/7\\/2023","Project End Date":"26\\/1\\/2032","4 Initiatives (Alberto 0224)":"Cloud"},"2":{"CRM ID":"20220804-1713","GTM Unit":"Public HK","Opportunity Owner":"Li Kenny KS","Account Owner":"Li Kenny KS","Account Name":"Immigration Department","Account Name (Local)":"\\u5165\\u5883\\u4e8b\\u52d9\\u8655","End Customer":"Immigration Department","Opportunity Name (English)":"Reprovisioning of an Information Technology (\\u201cIT\\u201d) Infrastructure atthe New Immigration Headquarters (\\u201cnew ImmD HQ\\u201d)","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":280000000.0,"EBITDA%":0.15,"Decision Date":"31\\/3\\/2024","Project Start Date":"15\\/1\\/2024","Project End Date":"15\\/7\\/2035","4 Initiatives (Alberto 0224)":"Cloud"},"3":{"CRM ID":"20220427-1348","GTM Unit":"Public HK","Opportunity Owner":"Li Kenny KS","Account Owner":"Li Kenny KS","Account Name":"Immigration Department","Account Name (Local)":"\\u5165\\u5883\\u4e8b\\u52d9\\u8655","End Customer":"Immigration Department","Opportunity Name (English)":"Network Infrastructure Set up for New Immd Headquarter","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O4 - Customer Decision","Winning Chance":"High","TCV (converted)":267105000.0,"EBITDA%":0.075,"Decision Date":"3\\/4\\/2023","Project Start Date":"1\\/5\\/2023","Project End Date":"1\\/4\\/2035","4 Initiatives (Alberto 0224)":"Cloud"},"4":{"CRM ID":"20200507-9032","GTM Unit":"Public HK","Opportunity Owner":"Yeung Chelsea LF","Account Owner":"Yeung Chelsea LF","Account Name":"Labour Department","Account Name (Local)":"\\u52de\\u5de5\\u8655","End Customer":"Labour Department","Opportunity Name (English)":"Designated Savings Account (DSA) System","Opportunity Name (Local)":null,"Major Solution Offering":"Custom Application Development","Project Manager":null,"Stage":"O2 - Qualify","Winning Chance":"Low","TCV (converted)":234000000.0,"EBITDA%":0.2,"Decision Date":"15\\/12\\/2023","Project Start Date":"16\\/12\\/2023","Project End Date":"16\\/12\\/2037","4 Initiatives (Alberto 0224)":"Smart City"},"5":{"CRM ID":"20220427-1346","GTM Unit":"Public HK","Opportunity Owner":"Hui Jerzy WC","Account Owner":"Hui Jerzy WC","Account Name":"Hong Kong Police Force","Account Name (Local)":"\\u9999\\u6e2f\\u8b66\\u52d9\\u8655","End Customer":"Hong Kong Police Force","Opportunity Name (English)":"Provision of Financial Data Analytic Platform for the Hong Kong Police Force","Opportunity Name (Local)":null,"Major Solution Offering":"Custom Application Development","Project Manager":null,"Stage":"O2 - Qualify","Winning Chance":"Low","TCV (converted)":200000000.0,"EBITDA%":0.2,"Decision Date":"31\\/3\\/2023","Project Start Date":"17\\/4\\/2023","Project End Date":"17\\/8\\/2031","4 Initiatives (Alberto 0224)":"Smart City"},"6":{"CRM ID":"20220427-1344","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Customs and Excise Department","Account Name (Local)":"\\u9999\\u6e2f\\u6d77\\u95dc","End Customer":"Customs and Excise Department","Opportunity Name (English)":"Smart Customs IT Infrastructure","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":150000000.0,"EBITDA%":0.08,"Decision Date":"19\\/6\\/2023","Project Start Date":"26\\/6\\/2023","Project End Date":"26\\/6\\/2037","4 Initiatives (Alberto 0224)":"Smart City"},"7":{"CRM ID":"20210305-0166","GTM Unit":"Public HK","Opportunity Owner":"Li Kenny KS","Account Owner":"Li Kenny KS","Account Name":"Immigration Department","Account Name (Local)":"\\u5165\\u5883\\u4e8b\\u52d9\\u8655","End Customer":"Immigration Department","Opportunity Name (English)":"New Immigration Enquiry Services System (IESS)","Opportunity Name (Local)":null,"Major Solution Offering":"Custom Application Development","Project Manager":null,"Stage":"O2 - Qualify","Winning Chance":"Low","TCV (converted)":101400000.0,"EBITDA%":0.1,"Decision Date":"30\\/12\\/2023","Project Start Date":"22\\/1\\/2024","Project End Date":"22\\/1\\/2036","4 Initiatives (Alberto 0224)":"Cloud"},"8":{"CRM ID":"20220427-1343","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Correctional Services","Account Name (Local)":"\\u61f2\\u6559\\u7f72","End Customer":"Correctional Services","Opportunity Name (English)":"Relocation of IT System to the New Correctional Services Department Headquarters and related System Enhancement","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":100000000.0,"EBITDA%":0.08,"Decision Date":"20\\/12\\/2023","Project Start Date":"26\\/1\\/2024","Project End Date":"26\\/6\\/2036","4 Initiatives (Alberto 0224)":"Cloud"},"9":{"CRM ID":"20220822-1766","GTM Unit":"Public HK","Opportunity Owner":"Hui Jerzy WC","Account Owner":"Hui Jerzy WC","Account Name":"Hong Kong Police Force","Account Name (Local)":"\\u9999\\u6e2f\\u8b66\\u52d9\\u8655","End Customer":"Hong Kong Police Force","Opportunity Name (English)":"Development of Traffic e-Enforcement System","Opportunity Name (Local)":null,"Major Solution Offering":"Custom Application Development","Project Manager":null,"Stage":"O2 - Qualify","Winning Chance":"Low","TCV (converted)":100000000.0,"EBITDA%":0.2,"Decision Date":"29\\/3\\/2024","Project Start Date":"30\\/3\\/2024","Project End Date":"30\\/3\\/2034","4 Initiatives (Alberto 0224)":"Smart City"},"10":{"CRM ID":"20220718-1644","GTM Unit":"Public HK","Opportunity Owner":"Fu Patrick CC","Account Owner":"Hui Jerzy WC","Account Name":"Hong Kong Police Force","Account Name (Local)":"\\u9999\\u6e2f\\u8b66\\u52d9\\u8655","End Customer":"Hong Kong Police Force","Opportunity Name (English)":"Radio System & other operation systems of Marine Police Tai Kok Tsui","Opportunity Name (Local)":null,"Major Solution Offering":"Communications","Project Manager":null,"Stage":"O2 - Qualify","Winning Chance":"Low","TCV (converted)":80000000.0,"EBITDA%":0.08,"Decision Date":"4\\/3\\/2024","Project Start Date":"8\\/3\\/2024","Project End Date":"8\\/3\\/2031","4 Initiatives (Alberto 0224)":"Cloud"},"11":{"CRM ID":"20220331-1271","GTM Unit":"Public HK","Opportunity Owner":"Li Kenny KS","Account Owner":"Li Kenny KS","Account Name":"Immigration Department","Account Name (Local)":"\\u5165\\u5883\\u4e8b\\u52d9\\u8655","End Customer":"Immigration Department","Opportunity Name (English)":"New Initiative for new HQs (New Kiosks for Smart Card and Travel Document Application and Collection)","Opportunity Name (Local)":null,"Major Solution Offering":"Application Managed Services","Project Manager":null,"Stage":"O4 - Customer Decision","Winning Chance":"Medium","TCV (converted)":72104172.0,"EBITDA%":0.11,"Decision Date":"30\\/4\\/2023","Project Start Date":44931,"Project End Date":"10\\/8\\/2030","4 Initiatives (Alberto 0224)":"Cloud"},"12":{"CRM ID":"20200612-9196","GTM Unit":"Public HK","Opportunity Owner":"Li Kenny KS","Account Owner":"Chan Houston HY","Account Name":"Health Bureau","Account Name (Local)":"\\u91ab\\u52d9\\u885e\\u751f\\u5c40","End Customer":"Health Bureau","Opportunity Name (English)":"ImmD - OCSSS System Revamp","Opportunity Name (Local)":null,"Major Solution Offering":"Application Managed Services","Project Manager":null,"Stage":"O4 - Customer Decision","Winning Chance":"Low","TCV (converted)":70999999.5900000036,"EBITDA%":0.12,"Decision Date":"30\\/4\\/2023","Project Start Date":"16\\/2\\/2023","Project End Date":"16\\/12\\/2033","4 Initiatives (Alberto 0224)":"Cloud"},"13":{"CRM ID":"20220804-1714","GTM Unit":"Public HK","Opportunity Owner":"Li Kenny KS","Account Owner":"Li Kenny KS","Account Name":"Immigration Department","Account Name (Local)":"\\u5165\\u5883\\u4e8b\\u52d9\\u8655","End Customer":"Immigration Department","Opportunity Name (English)":"ImmD HR System Revamp (HRMS)","Opportunity Name (Local)":null,"Major Solution Offering":null,"Project Manager":null,"Stage":"Closed Lost\\/Cancel","Winning Chance":"Low","TCV (converted)":70200049.1400000006,"EBITDA%":0.15,"Decision Date":"30\\/6\\/2023","Project Start Date":"30\\/6\\/2023","Project End Date":"30\\/11\\/2034","4 Initiatives (Alberto 0224)":0},"14":{"CRM ID":"20220619-1539","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Hospital Authority","Account Name (Local)":"\\u91ab\\u9662\\u7ba1\\u7406\\u5c40","End Customer":"Hospital Authority","Opportunity Name (English)":"Expansion of North District Hospital","Opportunity Name (Local)":null,"Major Solution Offering":"ELV","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":46800000.0,"EBITDA%":0.08,"Decision Date":"15\\/6\\/2023","Project Start Date":"16\\/6\\/2023","Project End Date":"16\\/6\\/2026","4 Initiatives (Alberto 0224)":"Cloud"},"15":{"CRM ID":"20220913-1840","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Hospital Authority","Account Name (Local)":"\\u91ab\\u9662\\u7ba1\\u7406\\u5c40","End Customer":"Hospital Authority","Opportunity Name (English)":"Extension of Operating Theatre Block of Tuen Mun Hospital","Opportunity Name (Local)":null,"Major Solution Offering":"ELV","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":46800000.0,"EBITDA%":0.08,"Decision Date":"30\\/6\\/2023","Project Start Date":"26\\/7\\/2023","Project End Date":"26\\/7\\/2026","4 Initiatives (Alberto 0224)":"Cloud"},"16":{"CRM ID":"20220427-1353","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Hospital Authority","Account Name (Local)":"\\u91ab\\u9662\\u7ba1\\u7406\\u5c40","End Customer":"Hospital Authority","Opportunity Name (English)":"Redevelopment of Grantham Hospital Phase 1","Opportunity Name (Local)":null,"Major Solution Offering":"ELV","Project Manager":null,"Stage":"O4 - Customer Decision","Winning Chance":"Low","TCV (converted)":41998316.0,"EBITDA%":0.08,"Decision Date":"27\\/3\\/2023","Project Start Date":"26\\/5\\/2023","Project End Date":"26\\/5\\/2026","4 Initiatives (Alberto 0224)":"Cloud"},"17":{"CRM ID":"20210713-0555","GTM Unit":"Public HK","Opportunity Owner":"Hui Jerzy WC","Account Owner":"Hui Jerzy WC","Account Name":"Hong Kong Police Force","Account Name (Local)":"\\u9999\\u6e2f\\u8b66\\u52d9\\u8655","End Customer":"Hong Kong Police Force","Opportunity Name (English)":"Automatic Identification System (AIS)","Opportunity Name (Local)":null,"Major Solution Offering":"Communications","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":40000000.0,"EBITDA%":0.2,"Decision Date":"31\\/3\\/2023","Project Start Date":"17\\/4\\/2023","Project End Date":"17\\/8\\/2026","4 Initiatives (Alberto 0224)":"Cloud"},"18":{"CRM ID":"20220619-1541","GTM Unit":"Public HK","Opportunity Owner":"Yeung Chelsea LF","Account Owner":"Yeung Chelsea LF","Account Name":"Housing Authority","Account Name (Local)":"\\u9999\\u6e2f\\u623f\\u5c4b\\u59d4\\u54e1\\u6703","End Customer":"Housing Authority","Opportunity Name (English)":"SAP ERP Finance and Procurement upgrade","Opportunity Name (Local)":null,"Major Solution Offering":"Custom Application Development","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":39000000.0,"EBITDA%":0.2,"Decision Date":"12\\/12\\/2023","Project Start Date":"13\\/12\\/2023","Project End Date":"13\\/12\\/2028","4 Initiatives (Alberto 0224)":"Cloud"},"19":{"CRM ID":"20220718-1623","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Correctional Services","Account Name (Local)":"\\u61f2\\u6559\\u7f72","End Customer":"Correctional Services","Opportunity Name (English)":"Network Infrastructure Equipment Set up","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":39000000.0,"EBITDA%":0.08,"Decision Date":"30\\/6\\/2023","Project Start Date":"26\\/7\\/2023","Project End Date":"26\\/7\\/2029","4 Initiatives (Alberto 0224)":"Cloud"},"20":{"CRM ID":"20230331-SF000851","GTM Unit":"Public HK","Opportunity Owner":"Patrick CC Fu","Account Owner":"Houston HY Chan","Account Name":"Customs and Excise Department","Account Name (Local)":"\\u9999\\u6e2f\\u6d77\\u95dc","End Customer":"Customs and Excise Department","Opportunity Name (English)":"BIT System for Customs in T2 HK Airport","Opportunity Name (Local)":null,"Major Solution Offering":null,"Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":38000000.0,"EBITDA%":0.08,"Decision Date":"31\\/8\\/2023","Project Start Date":"1\\/9\\/2023","Project End Date":"1\\/9\\/2026","4 Initiatives (Alberto 0224)":null},"21":{"CRM ID":"20230215-SF000504","GTM Unit":"Public HK","Opportunity Owner":"Tso Alma CY","Account Owner":"Lee Gary WK","Account Name":"Hong Kong Judiciary","Account Name (Local)":"\\u9999\\u6e2f\\u53f8\\u6cd5\\u6a5f\\u69cb","End Customer":"Hong Kong Judiciary","Opportunity Name (English)":"Infra for New Courts Building","Opportunity Name (Local)":null,"Major Solution Offering":"Infrastructure & Network Services","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Medium","TCV (converted)":32000000.0,"EBITDA%":0.1,"Decision Date":"1\\/3\\/2024","Project Start Date":"2\\/3\\/2024","Project End Date":"2\\/3\\/2025","4 Initiatives (Alberto 0224)":"Smart City"},"22":{"CRM ID":"20230328-SF000790","GTM Unit":"Public HK","Opportunity Owner":"Christy WH Kwong","Account Owner":"Gary WK Lee","Account Name":"Hong Kong Examinations and Assessment Authority","Account Name (Local)":"\\u9999\\u6e2f\\u8003\\u8a66\\u53ca\\u8a55\\u6838\\u5c40","End Customer":"Hong Kong Examinations and Assessment Authority","Opportunity Name (English)":"Provision of End-to-end Digital Assessment System","Opportunity Name (Local)":null,"Major Solution Offering":"Application Managed Services","Project Manager":null,"Stage":"Closed Lost\\/Cancel","Winning Chance":"Low","TCV (converted)":27982698.0,"EBITDA%":0.15,"Decision Date":"31\\/5\\/2023","Project Start Date":"1\\/6\\/2023","Project End Date":"1\\/12\\/2033","4 Initiatives (Alberto 0224)":null},"23":{"CRM ID":"20220804-1722","GTM Unit":"T&T","Opportunity Owner":"Yeung Chelsea LF","Account Owner":"Yeung Chelsea LF","Account Name":"Transport Department","Account Name (Local)":"\\u904b\\u8f38\\u7f72","End Customer":"Transport Department","Opportunity Name (English)":"Implementation and Operation of Online Platform for Auction of Vehicle Registration Marks","Opportunity Name (Local)":null,"Major Solution Offering":"Help Desk","Project Manager":null,"Stage":"O4 - Customer Decision","Winning Chance":"Medium","TCV (converted)":25852583.0,"EBITDA%":0.12,"Decision Date":"31\\/5\\/2023","Project Start Date":"1\\/6\\/2023","Project End Date":"1\\/9\\/2028","4 Initiatives (Alberto 0224)":"Smart City"},"24":{"CRM ID":"20230215-SF000472","GTM Unit":"Public HK","Opportunity Owner":"Tso Alma CY","Account Owner":"Li Kenny KS","Account Name":"Immigration Department","Account Name (Local)":"\\u5165\\u5883\\u4e8b\\u52d9\\u8655","End Customer":"Immigration Department","Opportunity Name (English)":"ImmD ICONS at new T2 - Facial Recognition","Opportunity Name (Local)":null,"Major Solution Offering":"eMerging","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Medium","TCV (converted)":25000000.0,"EBITDA%":0.05,"Decision Date":"31\\/5\\/2023","Project Start Date":"1\\/6\\/2023","Project End Date":"1\\/12\\/2034","4 Initiatives (Alberto 0224)":"Smart City"},"25":{"CRM ID":"20220718-1625","GTM Unit":"Public HK","Opportunity Owner":"Chan Houston HY","Account Owner":"Chan Houston HY","Account Name":"Correctional Services","Account Name (Local)":"\\u61f2\\u6559\\u7f72","End Customer":"Correctional Services","Opportunity Name (English)":"Central Pharmacy Inventory Control","Opportunity Name (Local)":null,"Major Solution Offering":"Custom Application Development","Project Manager":null,"Stage":"O1 - Initial","Winning Chance":"Low","TCV (converted)":23400000.0,"EBITDA%":0.15,"Decision Date":"30\\/6\\/2023","Project Start Date":"26\\/7\\/2023","Project End Date":"26\\/7\\/2025","4 Initiatives (Alberto 0224)":"Smart City"}}'
                     """},
                     {"role":"user","content":Quesiton}
                    ]
    
    completion = client.chat.completions.create(
      model="gpt-35-turbo-16k", # model = "deployment_name"
      messages = message_text,
      temperature=0,
      max_tokens=800,
    
    )
    
    return completion.choices[0].message.content
